# KoNLPy ë° í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ (ì½”ë©ì—ì„œ ì‹¤í–‰)
!pip install konlpy pandas

import pandas as pd
from konlpy.tag import Kkma
import os
import re # ë¬¸ìì—´ ì •ë¦¬ìš©

def analyze_by_king_and_save(input_filename='ì‹ì´ì „í•œê¸€.txt',
                             output_filename='ì™•ë³„_í˜•íƒœì†Œ_ë¶„ì„ê²°ê³¼2.csv',
                             encoding='cp949'):
    """
    íƒ­ êµ¬ë¶„ íŒŒì¼(TSV)ì„ ì½ì–´ 'ì™•'ë³„ 'ê¸°ì‚¬ì œëª©'ì„ í˜•íƒœì†Œ ë¶„ì„í•˜ê³ 
    'ì™•, í˜•íƒœì†Œ, í’ˆì‚¬' í˜•ì‹ìœ¼ë¡œ CSV íŒŒì¼ì„ ì €ì¥í•©ë‹ˆë‹¤.
    """
    kkma = Kkma()
    final_results = []

    # 1. Pandasë¡œ TXT (TSV) íŒŒì¼ ì½ê¸°
    try:
        # cp949 ì¸ì½”ë”©ìœ¼ë¡œ íƒ­ êµ¬ë¶„ íŒŒì¼ì„ ì½ìŠµë‹ˆë‹¤.
        df = pd.read_csv(input_filename, sep='\t', encoding=encoding, header=0, engine='python')
        print(f"ğŸ“„ '{input_filename}' íŒŒì¼ì„ ì„±ê³µì ìœ¼ë¡œ ì½ì—ˆìŠµë‹ˆë‹¤. (ì¸ì½”ë”©: {encoding})")

    except FileNotFoundError:
        print(f"âŒ ì˜¤ë¥˜: '{input_filename}' íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return
    except UnicodeDecodeError:
        print(f"âŒ ì˜¤ë¥˜: '{encoding}' ì¸ì½”ë”©ìœ¼ë¡œ íŒŒì¼ì„ ë””ì½”ë”©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. 'euc-kr' ë˜ëŠ” 'utf-8'ì„ ì‹œë„í•´ë³´ì„¸ìš”.")
        return
    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜: íŒŒì¼ ì½ê¸° ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
        return

    # 2. í•„ìš”í•œ ì»¬ëŸ¼ ì¶”ì¶œ ë° ì˜¤ë¥˜ ë°©ì§€ ë¡œì§
    # ì»¬ëŸ¼ëª… ì •ê·œí™”: ê³µë°±ì´ë‚˜ íŠ¹ìˆ˜ë¬¸ì ì œê±°
    df.columns = df.columns.str.strip()

    if 'ì™•' not in df.columns or 'ê¸°ì‚¬ì œëª©' not in df.columns:
        print("âŒ ì˜¤ë¥˜: íŒŒì¼ì— 'ì™•' ë˜ëŠ” 'ê¸°ì‚¬ì œëª©' ì»¬ëŸ¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì»¬ëŸ¼ëª…ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
        print(f"í˜„ì¬ ì»¬ëŸ¼ëª…: {df.columns.tolist()}")
        return

    # 3. ì™•ë³„ ê¸°ì‚¬ì œëª© í˜•íƒœì†Œ ë¶„ì„

    # NaN ê°’ì€ ë¹ˆ ë¬¸ìì—´ë¡œ ì²˜ë¦¬
    df = df.fillna('')

    for index, row in df.iterrows():
        king = row['ì™•'] # 'ì™•' ì»¬ëŸ¼ì˜ ê°’
        title = row['ê¸°ì‚¬ì œëª©'] # 'ê¸°ì‚¬ì œëª©' ì»¬ëŸ¼ì˜ í…ìŠ¤íŠ¸

        # í…ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ë¶„ì„ ì§„í–‰
        if title.strip():
            # í˜•íƒœì†Œ ë¶„ì„ ì‹¤í–‰
            analyzed_data = kkma.pos(title)

            # í˜•íƒœì†Œ ë¶„ì„ ê²°ê³¼ë¥¼ ìµœì¢… ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
            for morpheme, pos_tag in analyzed_data:
                final_results.append({
                    'ì™•': king,
                    'í˜•íƒœì†Œ': morpheme,
                    'í’ˆì‚¬': pos_tag
                })

    # 4. ê²°ê³¼ DataFrame ìƒì„± ë° CSV ì €ì¥
    if not final_results:
        print("âš ï¸ ë¶„ì„í•  ìœ íš¨í•œ í…ìŠ¤íŠ¸ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. í˜•íƒœì†Œ ë¶„ì„ì„ ì§„í–‰í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
        return

    df_final = pd.DataFrame(final_results)

    # CSV íŒŒì¼ ì €ì¥ì€ í‘œì¤€ì¸ 'utf-8'ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.
    df_final.to_csv(output_filename, index=False, encoding='utf-8')

    print(f"âœ… ì´ {len(df_final)}ê°œì˜ í˜•íƒœì†Œ ë¶„ì„ ê²°ê³¼ê°€ '{output_filename}' íŒŒì¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
    print("--- ì €ì¥ëœ CSV íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° (ìƒìœ„ 5ê°œ) ---")
    print(df_final.head())

# --- í•¨ìˆ˜ ì‹¤í–‰ ---
analyze_by_king_and_save(input_filename='ì‹ì´ì „í•œê¸€.txt')
